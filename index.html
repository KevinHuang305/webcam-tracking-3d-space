<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Webcam Face Tracking VR Window</title>
    <style>
        body {
            margin: 0;
            background-color: #1a1a1a;
            color: white;
            font-family: sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
        }

        .camera-container {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 160px;
            height: 120px;
            z-index: 100;
            border: 2px solid #555;
            background: black;
        }
        #webcam {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        #viewport {
            width: 800px;
            height: 600px;
            border: 20px solid #444;
            border-radius: 10px;
            position: relative;
            perspective: 1000px; 
            perspective-origin: 50% 50%; 
            background: #000;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
            overflow: hidden;
        }

        #scene {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: translateZ(0);
        }

        .wall {
            position: absolute;
            width: 800px;
            height: 600px;
            backface-visibility: hidden;
        }

        .back-wall {
            background: repeating-linear-gradient(45deg, #2b2b2b, #2b2b2b 20px, #333 20px, #333 40px);
            transform: translateZ(-500px);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 80px;
            color: rgba(255,255,255,0.1);
            border: 5px solid #555;
        }

        .floor {
            background: linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            background-color: #222;
            height: 1000px;
            transform: rotateX(90deg) translateZ(-300px) translateY(-500px);
        }

        .ceiling {
            background-color: #111;
            height: 1000px;
            transform: rotateX(-90deg) translateZ(-300px) translateY(500px);
        }

        .left-wall {
            background-color: #2a2a2a;
            width: 1000px;
            transform: rotateY(90deg) translateZ(-500px) translateX(-500px);
        }

        .right-wall {
            background-color: #2a2a2a;
            width: 1000px;
            transform: rotateY(-90deg) translateZ(-300px) translateX(500px);
        }

        .floating-box {
            position: absolute;
            width: 100px;
            height: 100px;
            background: rgba(255, 100, 100, 0.8);
            border: 2px solid white;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) translateZ(-100px); 
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(255, 100, 100, 0.6);
        }
        
        .floating-box-2 {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(100, 100, 255, 0.8);
            border: 2px solid white;
            top: 30%;
            left: 70%;
            transform: translate(-50%, -50%) translateZ(-300px);
        }
    </style>
</head>
<body>

    <div id="info">
        <h3>Webcam 頭部追蹤 (MediaPipe)</h3>
        <p id="status">正在載入模型...</p>
        <small>注意：請勿直接雙擊檔案，需透過 Server 開啟</small>
    </div>

    <div class="camera-container">
        <video id="webcam" autoplay playsinline></video>
    </div>

    <div id="viewport">
        <div id="scene">
            <div class="wall back-wall">DEEP SPACE</div>
            <div class="wall floor"></div>
            <div class="wall ceiling"></div>
            <div class="wall left-wall"></div>
            <div class="wall right-wall"></div>
            
            <div class="floating-box">Front</div>
            <div class="floating-box-2"></div>
        </div>
    </div>

    <script type="module">
        import {
            FilesetResolver,
            FaceLandmarker
        } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/+esm";

        const video = document.getElementById('webcam');
        const statusElement = document.getElementById('status');
        const viewport = document.getElementById('viewport');
        const scene = document.getElementById('scene');
        
        let faceLandmarker;
        let lastVideoTime = -1;
        let runningMode = "VIDEO";

        // 1. 初始化 MediaPipe FaceLandmarker
        async function createFaceLandmarker() {
            try {
                // 這裡載入 WASM 檔案，這是一個二進位檔案，通常會被瀏覽器安全策略擋住
                const vision = await FilesetResolver.forVisionTasks(
                    "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
                );
                
                faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                    baseOptions: {
                        modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                        delegate: "GPU"
                    },
                    outputFaceBlendshapes: false,
                    runningMode: runningMode,
                    numFaces: 1
                });
                
                statusElement.innerText = "模型已載入，正在啟動攝影機...";
                startWebcam();
            } catch (error) {
                console.error(error);
                statusElement.innerText = "載入失敗: " + error.message;
                alert("載入失敗！請確保您不是直接雙擊 HTML 檔案，而是透過 Local Server (如 http://localhost:...) 開啟。");
            }
        }

        // 2. 啟動 Webcam
        function startWebcam() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then((stream) => {
                    video.srcObject = stream;
                    video.addEventListener("loadeddata", predictWebcam);
                    statusElement.innerText = "追蹤中 (移動頭部看看效果!)";
                })
                .catch((err) => {
                    console.error(err);
                    statusElement.innerText = "無法存取攝影機";
                });
        }

        // 3. 即時預測與渲染迴圈
        async function predictWebcam() {
            if (video.currentTime !== lastVideoTime) {
                lastVideoTime = video.currentTime;
                let startTimeMs = performance.now();
                
                if (faceLandmarker) {
                    const result = faceLandmarker.detectForVideo(video, startTimeMs);
                    
                    if (result.faceLandmarks.length > 0) {
                        const landmarks = result.faceLandmarks[0];
                        // 索引 168 是眉心位置
                        const noseBridge = landmarks[168]; 
                        updatePerspective(noseBridge.x, noseBridge.y, noseBridge.z);
                    }
                }
            }
            window.requestAnimationFrame(predictWebcam);
        }

        // 4. 更新 CSS 透視效果
        function updatePerspective(x, y, z) {
            // 放大移動效果係數
            const sensitivity = 2000; 

            // MediaPipe 座標系：x (左0->右1), y (上0->下1)
            // 轉為 CSS perspective-origin 百分比 (中心是 50%)
            // 反向計算以模擬視窗效果：頭往左(x小)，視角要能看到右邊(origin變大)
            const originX = 50 + (x - 0.5) * 300; 
            const originY = 50 + (y - 0.5) * 300;
            
            viewport.style.perspectiveOrigin = `${originX}% ${originY}%`;

            // 加入旋轉增強立體感
            const rotateY = (x - 0.5) * 40; 
            const rotateX = -(y - 0.5) * 40; 

            scene.style.transform = `
                translateZ(0) 
                rotateX(${rotateX}deg) 
                rotateY(${rotateY}deg)
            `;
        }

        // 啟動程式
        createFaceLandmarker();
    </script>
</body>
</html>